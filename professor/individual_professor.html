<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Aluno | SME FMM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- TASK 3.2.1: Importação do Cliente Global Supabase -->
    <script src="../assets/js/supabase_client.js"></script>
    <!-- TASK 2.3.1: Importação do Componente de Sidebar -->
    <script src="../sidebar.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fmm: {
                            dark: '#003c5b',
                            blue: '#00638f',
                            green: '#80a51b',
                            lime: '#c8d400',
                            bg: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-item-active { background-color: rgba(200, 212, 0, 0.15); border-left: 4px solid #c8d400; color: #ffffff !important; }
        .sidebar-collapsed .sidebar-text, .sidebar-collapsed .sidebar-category { display: none; }
        .sidebar-collapsed .sidebar-item { justify-content: center; padding: 12px 0; }
        .sidebar-collapsed .logo-full { display: none; }
        .sidebar-collapsed .logo-short { display: block; }
        .logo-short { display: none; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 3px solid #f1f5f9; }

        .tab-btn { padding: 10px 24px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; border-radius: 14px; transition: all 0.2s; color: #64748b; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: #003c5b; color: white; box-shadow: 0 4px 12px rgba(0, 60, 91, 0.2); }

        .info-pill { background: white; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 8px; }

        .grade-input { width: 60px; text-align: center; border-radius: 10px; border: 2px solid #e2e8f0; padding: 8px 2px; font-weight: 800; font-size: 14px; transition: all 0.2s; background: white; }
        .grade-input:focus { border-color: #00638f; outline: none; background: #fff; transform: scale(1.05); z-index: 10; }
        .grade-low { color: #ef4444; border-color: #fecaca; background: #fef2f2; }
        .grade-ok { color: #00638f; border-color: #e2e8f0; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide { animation: slideInRight 0.4s ease-out forwards; }
        .search-result-item:hover { background-color: #f8fafc; }
        
        .chat-bubble { position: relative; background: white; border-radius: 24px; border-top-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; padding: 24px; transition: all 0.2s; }
        .chat-bubble:hover { border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        .tag-badge { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 8px; letter-spacing: 0.05em; }
        .tag-comportamental { background: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }
        .tag-academico { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .tag-familiar { background: #f0fdf4; color: #22c55e; border: 1px solid #dcfce7; }
        .tag-saude { background: #faf5ff; color: #a855f7; border: 1px solid #f3e8ff; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <aside id="sidebar-container" class="sidebar-transition w-72 bg-fmm-dark text-white flex-shrink-0 flex flex-col shadow-2xl relative z-20"></aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="bg-white h-20 border-b flex items-center justify-between px-8 z-30 shadow-sm flex-shrink-0">
            <div class="flex items-center gap-6 flex-1">
                <h1 class="text-base font-black text-fmm-dark tracking-tight flex items-center gap-2"><span class="w-1.5 h-4 bg-fmm-lime rounded-full"></span>Individual</h1>
                <div class="h-8 w-px bg-slate-100 hidden md:block"></div>
                <div class="relative w-full max-w-sm">
                    <i data-lucide="search" class="absolute left-4 top-3 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="studentSearch" onkeyup="searchAlunos(this.value)" placeholder="Nome ou RA..." class="w-full pl-11 pr-4 py-2.5 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-4 focus:ring-fmm-blue/5 focus:border-fmm-blue transition-all font-medium text-sm">
                    <div id="searchResults" class="absolute w-full mt-2 bg-white border border-slate-200 rounded-2xl shadow-2xl max-h-64 overflow-y-auto z-50 hidden custom-scrollbar"></div>
                </div>
                <div class="flex flex-col min-w-[220px]">
                    <select id="selectDisc" onchange="handleContextChange()" class="w-full px-4 py-2.5 bg-fmm-blue/5 border border-fmm-blue/10 rounded-2xl outline-none focus:ring-4 focus:ring-fmm-blue/5 text-xs font-bold text-fmm-blue">
                        <option value="">Selecione sua disciplina...</option>
                    </select>
                </div>
            </div>
            <div id="sync-status" class="hidden items-center gap-2 px-3 py-1.5 bg-fmm-blue/5 rounded-full border border-fmm-blue/10 animate-pulse">
                <i data-lucide="refresh-ccw" class="w-3.5 h-3.5 text-fmm-blue"></i><span class="text-[9px] font-black text-fmm-blue uppercase tracking-widest">Sincronizando</span>
            </div>
        </header>

        <div class="flex-1 overflow-auto custom-scrollbar bg-slate-50" id="main-content">
            <div id="empty-view" class="h-full flex flex-col items-center justify-center p-20 text-center">
                <div class="w-24 h-24 bg-white rounded-[32px] shadow-xl flex items-center justify-center mb-8 border border-slate-50"><i data-lucide="user-plus" class="w-10 h-10 text-slate-200"></i></div>
                <h3 class="text-xl font-extrabold text-slate-400 tracking-tight">Conselho de Classe Individual</h3>
                <p id="empty-msg" class="text-sm text-slate-300 italic mt-2">Pesquise um aluno para gerir dados detalhados.</p>
            </div>

            <div id="student-view" class="hidden p-8 space-y-8 animate-slide">
                <div class="bg-white rounded-[40px] p-8 shadow-xl border border-slate-100 flex flex-col lg:flex-row gap-10 items-start lg:items-center">
                    <div class="relative group cursor-pointer flex-shrink-0" onclick="openPhotoZoom()"><img id="studentAvatar" src="" class="w-28 h-28 rounded-[32px] object-cover border-4 border-slate-50 shadow-md"></div>
                    <div class="flex-1 space-y-4 w-full">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div><h2 id="studentName" class="text-2xl font-black text-fmm-dark tracking-tight leading-none mb-1">---</h2><p class="text-slate-400 font-bold text-xs uppercase tracking-widest" id="studentInfo">RA: --- | Turma: ---</p></div>
                            <span id="studentStatus" class="w-fit px-4 py-1.5 rounded-full text-[9px] font-black uppercase bg-fmm-green/10 text-fmm-green border border-fmm-green/10">Cursando</span>
                        </div>
                        <div class="flex flex-wrap gap-3"><div class="info-pill"><i data-lucide="mail" class="w-3.5 h-3.5 text-fmm-blue"></i> <span id="studentEmail">---</span></div><div class="info-pill"><i data-lucide="users" class="w-3.5 h-3.5 text-fmm-blue"></i> <span id="studentTurmaNome">---</span></div></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                        <div class="bg-slate-200/50 p-1 rounded-2xl flex gap-1"><button onclick="switchStudentTab('frequencia')" id="tab-freq" class="tab-btn active"><i data-lucide="calendar-days" class="w-4 h-4"></i> Frequência</button><button onclick="switchStudentTab('notas')" id="tab-notas" class="tab-btn"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Notas e Médias</button></div>
                        <div class="text-right"><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Gerindo Dados em</p><h4 id="selected-disc-label" class="text-sm font-black text-fmm-blue uppercase">Selecione uma matéria</h4></div>
                    </div>

                    <div id="content-frequencia" class="animate-slide space-y-6">
                        <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-4">
                            <div class="flex-1 w-full space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Lançar Falta</label>
                            <div class="flex gap-2"><input type="date" id="newAbsenceDate" class="flex-1 px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl text-sm font-bold"><select id="newAbsenceTime" class="w-32 px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl text-sm font-bold"><option value="1">1º Tempo</option><option value="2">2º Tempo</option></select><button onclick="addAbsence()" class="bg-fmm-dark text-white px-6 py-2 rounded-xl text-xs font-black uppercase">Lançar</button></div></div>
                        </div>
                        <div class="bg-white rounded-[32px] border border-slate-100 shadow-xl overflow-hidden">
                            <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                                <h4 class="font-black text-fmm-dark text-xs uppercase">Registos de Ausência</h4>
                                <div id="total-faltas" class="px-4 py-1.5 bg-red-50 text-red-600 text-[10px] font-black rounded-full border border-red-100">0 FALTAS</div>
                            </div>
                            <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50/50 text-[10px] font-black uppercase text-slate-400 tracking-widest"><tr><th class="px-8 py-5">Data</th><th class="px-6 py-5 text-center">Tempo</th><th class="px-8 py-5 text-right">Ações</th></tr></thead><tbody id="freq-list" class="divide-y divide-slate-50 text-sm font-medium"></tbody></table></div>
                        </div>
                    </div>

                    <div id="content-notas" class="hidden animate-slide">
                        <div class="bg-white rounded-[32px] border border-slate-100 shadow-xl overflow-hidden">
                            <div id="notas-grid-container" class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-100 bg-white"></div>
                            <div id="anual-consolidado-area" class="bg-slate-50 p-8 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-10">
                                <div class="flex gap-10"><div class="flex flex-col"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Média Anual</span><span id="label-media-anual" class="text-3xl font-black text-fmm-dark">0.0</span></div><div class="h-12 w-px bg-slate-200"></div><div class="flex flex-col"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Média Final</span><span id="label-media-final" class="text-3xl font-black text-fmm-blue">0.0</span></div></div>
                                <div class="flex gap-6"><div class="flex flex-col gap-1.5"><label class="text-[9px] font-black text-slate-400 uppercase text-center">Rec. Final</label><input type="text" id="in-recup-final" oninput="handleInputGrade(this, 'ANUAL', 'recup_final')" class="grade-input bg-amber-50"></div><div class="flex flex-col gap-1.5"><label class="text-[9px] font-black text-slate-400 uppercase text-center">Conselho</label><input type="text" id="in-conselho" oninput="handleInputGrade(this, 'ANUAL', 'conselho_classe')" class="grade-input bg-blue-50"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL FOTO -->
    <div id="photoModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-4" onclick="closePhotoModal()">
        <div class="relative animate-fade-in-up" onclick="event.stopPropagation()">
            <button onclick="closePhotoModal()" class="absolute -top-12 -right-4 text-white hover:text-fmm-lime transition-colors">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <img id="enlargedPhoto" src="" class="max-w-[90vw] max-h-[80vh] rounded-[40px] shadow-2xl border-4 border-white/10 object-contain">
            <div id="enlargedName" class="mt-4 text-center text-white font-bold text-lg tracking-tight"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-8 right-8 z-50 translate-y-20 opacity-0 transition-all duration-500">
        <div class="bg-slate-900 text-white px-8 py-5 rounded-2xl shadow-2xl flex items-center gap-4 border border-white/5">
            <div class="w-8 h-8 bg-fmm-lime/20 rounded-full flex items-center justify-center" id="toast-icon-container">
                <i data-lucide="check" class="w-4 h-4 text-fmm-lime" id="toast-icon"></i>
            </div>
            <span class="text-xs font-bold tracking-tight" id="toast-msg">Sincronizado</span>
        </div>
    </div>

    <script>
        // TASK 3.2.1: supabaseClient agora é global vindo de ../assets/js/supabase_client.js

        let currentUser = null, selectedStudent = null, currentMatriculaId = null, currentDiscSigla = "", currentDiscType = "BCC", activeTab = 'frequencia', saveTimers = {};

        function formatDriveUrl(url) {
            if (!url) return null;
            if (url.includes('drive.google.com') && url.includes('/file/d/')) {
                const idMatch = url.match(/\/d\/(.*?)\//);
                if (idMatch && idMatch[1]) return `https://lh3.googleusercontent.com/d/${idMatch[1]}`;
            }
            return url;
        }

        async function init() {
            if(window.SidebarComponent) await SidebarComponent.render('sidebar-container');
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) return window.location.href = '../index.html';
            const { data: profile } = await window.supabaseClient.from('perfis').select('*').eq('id', user.id).single();
            currentUser = profile;
            document.getElementById('newAbsenceDate').valueAsDate = new Date();
            await populateTeacherDisciplines();
            lucide.createIcons();
        }

        async function populateTeacherDisciplines() {
            const select = document.getElementById('selectDisc');
            let disciplines = [];
            if (currentUser.cargo === 'coordenador' || currentUser.cargo === 'diretor') {
                const { data } = await window.supabaseClient.from('disciplinas').select('*').order('nome');
                disciplines = data || [];
            } else {
                const { data: vinculos } = await window.supabaseClient.from('professor_disciplinas').select('sigla_disciplina, disciplinas(*)').eq('id_professor', currentUser.id);
                disciplines = (vinculos || []).map(v => v.disciplinas).filter(d => d !== null);
                disciplines.sort((a, b) => a.nome.localeCompare(b.nome));
            }
            select.innerHTML = '<option value="">Selecione sua disciplina...</option>' + disciplines.map(d => `<option value="${d.sigla}" data-tipo="${d.tipo}">${d.nome} (${d.sigla})</option>`).join('');
            if(disciplines.length === 1) { select.value = disciplines[0].sigla; handleContextChange(); }
        }

        async function searchAlunos(val) {
            const results = document.getElementById('searchResults');
            if (!val || val.length < 2) return results.classList.add('hidden');
            const { data } = await window.supabaseClient.from('alunos').select('*, turmas(nome, serie)').or(`nome_completo.ilike.%${val}%,ra.ilike.%${val}%`).limit(5);
            if (data && data.length > 0) { results.innerHTML = data.map(a => `<div onclick="loadStudent('${a.ra}')" class="p-4 search-result-item cursor-pointer flex items-center gap-4 border-b border-slate-50 last:border-0 transition-colors"><img src="${formatDriveUrl(a.url_foto) || 'https://ui-avatars.com/api/?name='+encodeURIComponent(a.nome_completo)}" class="w-10 h-10 rounded-xl object-cover shadow-sm"><div class="flex flex-col"><span class="text-sm font-black text-fmm-dark">${a.nome_completo}</span><span class="text-[9px] text-slate-400 font-bold uppercase">${a.turmas?.nome || 'Sem Turma'} | RA: ${a.ra}</span></div></div>`).join(''); results.classList.remove('hidden'); }
            else results.classList.add('hidden');
        }

        async function loadStudent(ra) {
            document.getElementById('searchResults').classList.add('hidden'); 
            document.getElementById('studentSearch').value = '';
            
            // --- VALIDAÇÃO INICIAL DE CONTEXTO ---
            if (!currentDiscSigla) {
                alert("Por favor, selecione sua disciplina primeiro para validar o acesso ao aluno.");
                return;
            }

            const { data: student } = await window.supabaseClient.from('alunos').select('*, turmas(*)').eq('ra', ra).single();
            const { data: matricula } = await window.supabaseClient.from('matriculas').select('id').eq('ra_aluno', ra).eq('ano_letivo', 2026).maybeSingle();
            
            // --- LÓGICA DE SEGURANÇA E ACESSO (SUBTURMA OU TURMA REGULAR) ---
            if (currentUser.cargo === 'professor') {
                const s = document.getElementById('selectDisc');
                const discName = s.options[s.selectedIndex]?.text || "";
                const isIngles = currentDiscSigla === 'L.ING' || discName.toUpperCase().includes('INGLÊS');

                if (isIngles) {
                    // Verificação para Inglês (Subturmas)
                    const { data: subturma } = await window.supabaseClient.from('subturmas')
                        .select('id')
                        .eq('id_turma_origem', student.id_turma)
                        .eq('id_professor', currentUser.id)
                        .maybeSingle();

                    if (!subturma || student.id_subturma_ingles !== subturma.id) {
                        return denyAccess("Este aluno pertence a outro grupo de Inglês.");
                    }
                } else {
                    // Verificação para Disciplinas Regulares
                    // O professor deve estar vinculado a esta disciplina E a esta turma do aluno
                    const { data: vinculoRegular } = await window.supabaseClient.from('professor_disciplinas')
                        .select('id')
                        .eq('id_professor', currentUser.id)
                        .eq('sigla_disciplina', currentDiscSigla)
                        .eq('id_turma', student.id_turma)
                        .maybeSingle();

                    if (!vinculoRegular) {
                        return denyAccess("Você não leciona nesta turma para a disciplina selecionada.");
                    }
                }
            }

            // Se chegou aqui, o acesso foi concedido
            selectedStudent = student; currentMatriculaId = matricula?.id || null;
            document.getElementById('empty-view').classList.add('hidden'); 
            document.getElementById('student-view').classList.remove('hidden');
            document.getElementById('empty-msg').innerHTML = "Pesquise um aluno para gerir dados detalhados.";
            document.getElementById('studentName').innerText = student.nome_completo;
            document.getElementById('studentAvatar').src = formatDriveUrl(student.url_foto) || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome_completo)}&background=random&color=fff`;
            document.getElementById('studentInfo').innerText = `RA: ${student.ra} • ${student.turmas?.serie || 'Sem Série'}`;
            document.getElementById('studentEmail').innerText = student.email_institucional;
            document.getElementById('studentTurmaNome').innerText = student.turmas?.nome || 'Não Alocado';
            document.getElementById('studentStatus').innerText = student.status;
            
            loadContextData();
            lucide.createIcons();
        }

        // Função auxiliar para negar acesso
        function denyAccess(msg) {
            selectedStudent = null;
            currentMatriculaId = null;
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('empty-view').classList.remove('hidden');
            document.getElementById('empty-msg').innerHTML = `<span class="text-red-500 font-bold">ACESSO NEGADO:</span> ${msg}`;
            return false;
        }

        function handleContextChange() {
            const s = document.getElementById('selectDisc'); 
            currentDiscSigla = s.value; 
            currentDiscType = s.options[s.selectedIndex]?.dataset.tipo;
            document.getElementById('selected-disc-label').innerText = s.options[s.selectedIndex]?.text || "Selecione uma matéria";
            
            // Se já houver um aluno carregado, re-valida a permissão de visualização para o novo contexto de disciplina
            if (selectedStudent) loadStudent(selectedStudent.ra);
        }

        async function loadContextData() { 
            if (!selectedStudent || !currentDiscSigla) return;
            if (activeTab === 'frequencia') refreshFrequency(); 
            else refreshGrades(); 
        }

        async function refreshFrequency() {
            if (!selectedStudent || !currentDiscSigla) return;
            const { data: faltas } = await window.supabaseClient.from('frequencias').select('*').eq('ra_aluno', selectedStudent.ra).eq('sigla_disciplina', currentDiscSigla).eq('presente', false).order('data_presenca', { ascending: false });
            const { count } = await window.supabaseClient.from('frequencias').select('*', { count: 'exact', head: true }).eq('ra_aluno', selectedStudent.ra).eq('sigla_disciplina', currentDiscSigla).eq('presente', false);
            document.getElementById('total-faltas').innerText = `${count || 0} FALTAS`;
            const list = document.getElementById('freq-list');
            if (!faltas || faltas.length === 0) list.innerHTML = `<tr><td colspan="3" class="px-8 py-12 text-center text-slate-300 italic font-medium">Nenhum registo de falta.</td></tr>`;
            else list.innerHTML = faltas.map(f => `<tr class="hover:bg-red-50/20"><td class="px-8 py-5 font-black text-slate-700">${f.data_presenca.split('-').reverse().join('/')}</td><td class="px-6 py-5 text-center"><span class="px-3 py-1 bg-fmm-blue/5 text-fmm-blue text-[10px] font-black rounded-lg uppercase">TEMPO ${f.numero_tempo}</span></td><td class="px-8 py-5 text-right"><button onclick="removeAbsence('${f.id}')" class="p-2 text-slate-300 hover:text-red-500 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
            lucide.createIcons();
        }

        async function addAbsence() { const d = document.getElementById('newAbsenceDate').value, t = parseInt(document.getElementById('newAbsenceTime').value); if(!currentDiscSigla || !selectedStudent) return; const { error } = await window.supabaseClient.from('frequencias').upsert({ ra_aluno: selectedStudent.ra, sigla_disciplina: currentDiscSigla, id_turma: selectedStudent.id_turma, data_presenca: d, numero_tempo: t, presente: false }); if(!error) { showToast("Falta lançada"); refreshFrequency(); } }
        async function removeAbsence(id) { if (!confirm("Remover esta falta?")) return; const { error } = await window.supabaseClient.from('frequencias').delete().eq('id', id); if (!error) { showToast("Registo removido"); refreshFrequency(); } }

        async function refreshGrades() {
            if (!currentMatriculaId || !currentDiscSigla) return;
            const container = document.getElementById('notas-grid-container');
            if (currentDiscType === 'BCC') {
                const { data: notas } = await window.supabaseClient.from('notas_basica').select('*').eq('id_matricula', currentMatriculaId).eq('sigla_disciplina', currentDiscSigla);
                const { data: anual } = await window.supabaseClient.from('anual_basica').select('*').eq('id_matricula', currentMatriculaId).eq('sigla_disciplina', currentDiscSigla).maybeSingle();
                const periodos = ['1_TRIMESTRE', '2_TRIMESTRE', '3_TRIMESTRE'];
                container.innerHTML = periodos.map(p => {
                    const n = (notas || []).find(x => x.periodo === p) || { p1: 0, p2: 0, rt: 0, nt: 0 };
                    return `<div class="p-8 space-y-6"><h5 class="text-[10px] font-black text-fmm-blue uppercase tracking-widest border-b pb-2">${p.replace('_', ' ')}</h5><div class="grid grid-cols-2 gap-4"><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">P1</span><input type="text" id="p1-${p}" value="${n.p1 || '0'}" oninput="handleInputGrade(this, 'BCC', 'p1', '${p}')" class="grade-input"></div><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">P2</span><input type="text" id="p2-${p}" value="${n.p2 || '0'}" oninput="handleInputGrade(this, 'BCC', 'p2', '${p}')" class="grade-input"></div><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">RT</span><input type="text" id="rt-${p}" value="${n.rt || '0'}" oninput="handleInputGrade(this, 'BCC', 'rt', '${p}')" class="grade-input"></div><div class="flex flex-col justify-end pb-1"><span class="text-[9px] font-bold text-slate-400 uppercase">Final</span><span id="nt-${p}" class="text-xl font-black ${n.nt < 6 ? 'text-red-500' : 'text-fmm-blue'}">${Number(n.nt).toFixed(1)}</span></div></div></div>`;
                }).join('');
                document.getElementById('anual-consolidado-area').classList.remove('hidden');
                document.getElementById('label-media-anual').innerText = Number(anual?.media_anual || 0).toFixed(1);
                document.getElementById('label-media-final').innerText = Number(anual?.media_final || 0).toFixed(1);
                document.getElementById('in-recup-final').value = anual?.recup_final || '0';
                document.getElementById('in-conselho').value = anual?.conselho_classe || '0';
            } else {
                const { data: nTec } = await window.supabaseClient.from('notas_tecnica').select('*').eq('id_matricula', currentMatriculaId).eq('sigla_disciplina', currentDiscSigla);
                const periodos = ['1_SEMESTRE', '2_SEMESTRE'];
                container.innerHTML = periodos.map(p => {
                    const n = (nTec || []).find(x => x.periodo === p) || { p1: 0, p2: 0, media_1: 0, recup_parcial: 0, conselho_semestral: 0, media_2: 0, recup_final_semestral: 0, nota_final_periodo: 0 };
                    return `<div class="p-8 space-y-6"><h5 class="text-[10px] font-black text-fmm-green uppercase tracking-widest border-b pb-2">${p.replace('_', ' ')}</h5><div class="grid grid-cols-2 gap-4"><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">P1</span><input type="text" value="${n.p1 || '0'}" oninput="handleInputGrade(this, 'TEC', 'p1', '${p}')" class="grade-input"></div><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">P2</span><input type="text" value="${n.p2 || '0'}" oninput="handleInputGrade(this, 'TEC', 'p2', '${p}')" class="grade-input"></div><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">Rec. P.</span><input type="text" value="${n.recup_parcial || '0'}" oninput="handleInputGrade(this, 'TEC', 'recup_parcial', '${p}')" class="grade-input"></div><div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-400 uppercase">Cons.</span><input type="text" value="${n.conselho_semestral || '0'}" oninput="handleInputGrade(this, 'TEC', 'conselho_semestral', '${p}')" class="grade-input"></div><div class="flex flex-col col-span-2 border-t pt-3 mt-2"><span class="text-[9px] font-bold text-slate-400 uppercase">Nota Final</span><span class="text-2xl font-black ${n.nota_final_periodo < 6 ? 'text-red-500' : 'text-fmm-green'}">${Number(n.nota_final_periodo).toFixed(1)}</span></div></div></div>`;
                }).join('');
                document.getElementById('anual-consolidado-area').classList.add('hidden');
            }
        }

        function handleInputGrade(el, type, field, p = null) {
            const vS = el.value.replace(',', '.'); if (vS !== '' && (isNaN(vS) || vS < 0 || vS > 10)) { el.classList.add('ring-2', 'ring-red-500'); return; } el.classList.remove('ring-2', 'ring-red-500');
            const v = vS === '' ? 0 : parseFloat(vS);
            const timerKey = `${field}-${p}`; if (saveTimers[timerKey]) clearTimeout(saveTimers[timerKey]);
            document.getElementById('sync-status').classList.remove('hidden');
            saveTimers[timerKey] = setTimeout(() => { saveData(type, field, v, p); }, 1200);
        }

        async function saveData(type, field, val, periodo) {
            try {
                let error; const conflict = type === 'ANUAL' ? 'id_matricula,sigla_disciplina' : 'id_matricula,sigla_disciplina,periodo';
                const table = type === 'BCC' ? 'notas_basica' : (type === 'ANUAL' ? 'anual_basica' : 'notas_tecnica');
                const payload = { id_matricula: currentMatriculaId, sigla_disciplina: currentDiscSigla, [field]: val };
                if (periodo && type !== 'ANUAL') payload.periodo = periodo;
                ({ error } = await window.supabaseClient.from(table).upsert(payload, { onConflict: conflict }));
                if (error) throw error; showToast("Sincronizado"); refreshGrades();
            } catch (err) { console.error(err); } finally { document.getElementById('sync-status').classList.add('hidden'); }
        }

        function switchStudentTab(tab) { activeTab = tab; document.getElementById('tab-freq').classList.toggle('active', tab === 'frequencia'); document.getElementById('tab-notas').classList.toggle('active', tab === 'notas'); document.getElementById('content-frequencia').classList.toggle('hidden', tab !== 'frequencia'); document.getElementById('content-notas').classList.toggle('hidden', tab !== 'notas'); loadContextData(); }
        function toggleSidebar() { if(window.SidebarComponent) SidebarComponent.toggleSidebar(); }
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.replace('opacity-0', 'opacity-100'); t.classList.replace('translate-y-20', 'translate-y-0'); setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); t.classList.replace('translate-y-0', 'translate-y-20'); }, 2500); }
        function openPhotoZoom() { if(selectedStudent) { const url = formatDriveUrl(selectedStudent.url_foto) || `https://ui-avatars.com/api/?name=${encodeURIComponent(selectedStudent.nome_completo)}&background=random&color=fff`; document.getElementById('enlargedPhoto').src = url; document.getElementById('enlargedName').innerText = selectedStudent.nome_completo; document.getElementById('photoModal').classList.remove('hidden'); } }
        function closePhotoModal() { document.getElementById('photoModal').classList.add('hidden'); }
        window.onload = init;
    </script>
</body>
</html>