<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Geral | SME FMM</title>
        
    <!-- Configurações PWA e Mobile -->
    <meta name="theme-color" content="#003c5b">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Infraestrutura FMM 2026 -->
    <script src="../../assets/js/supabase_client.js"></script>
    <script src="../../sidebar.js"></script>
    <script src="../../assets/js/constants.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fmm: { 
                            dark: '#003c5b', 
                            blue: '#00638f', 
                            green: '#80a51b', 
                            lime: '#c8d400',
                            slate: '#f1f5f9'
                        }
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        /* --- SIDEBAR CORRIGIDA --- */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Oculta textos e setas quando minimizado */
        .sidebar-collapsed .sidebar-text, 
        .sidebar-collapsed .sidebar-category-title, 
        .sidebar-collapsed .chevron-icon { display: none; }
        
        /* Centraliza ícones quando minimizado */
        .sidebar-collapsed .sidebar-item { justify-content: center; padding: 12px 0; }
        .sidebar-collapsed .sidebar-category-header { justify-content: center; padding: 12px 0; }
        
        /* LOGO */
        .sidebar-collapsed .logo-full { display: none; }
        .sidebar-collapsed .logo-short { display: block; }
        .logo-short { display: none; }

        /* FIX CRÍTICO: Quando minimizado, força o conteúdo do acordeão a aparecer para mostrar os ícones */
        .sidebar-collapsed .category-content { 
            max-height: none !important; 
            overflow: visible !important; 
            background: transparent !important;
        }
        
        .category-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .category-content.open { max-height: 1000px; }
        .rotate-180 { transform: rotate(180deg); }

        /* --- SCROLLBARS --- */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- STICKY HEADERS & COLUMNS (TABELA) --- */
        thead th {
            position: sticky; 
            top: 0; 
            background-color: #0f172a !important; 
            color: #94a3b8 !important; 
            z-index: 30;
            border-bottom: 2px solid #1e293b;
            text-transform: uppercase;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.1em;
            padding: 12px 8px; /* Reduzido padding vertical */
            white-space: nowrap;
        }

        /* Coluna RA */
        .sticky-col-ra {
            position: sticky; left: 0; z-index: 20; 
            border-right: 1px solid #e2e8f0;
            min-width: 60px; background-color: white;
        }
        
        /* Coluna Aluno */
        .sticky-col-aluno {
            position: sticky; left: 60px; z-index: 20; 
            border-right: 2px solid #cbd5e1;
            min-width: 220px; max-width: 300px; /* Limite de largura para não estourar */
            background-color: white;
            box-shadow: 4px 0 10px -4px rgba(0,0,0,0.08);
        }

        /* Interseção (Canto Superior Esquerdo) */
        thead th.sticky-col-ra, 
        thead th.sticky-col-aluno { 
            z-index: 40; 
            background-color: #0f172a !important; 
            color: #ffffff !important;
            border-right: 1px solid #334155;
        }

        /* Manter cor de fundo nas colunas fixas ao rolar e hover */
        tbody tr:nth-child(even) td.sticky-col-ra,
        tbody tr:nth-child(even) td.sticky-col-aluno { background-color: #f8fafc; }
        tbody tr:hover td.sticky-col-ra,
        tbody tr:hover td.sticky-col-aluno { background-color: #f1f5f9 !important; }

        /* Modal e Loader */
        .modal-backdrop { background-color: rgba(0, 30, 45, 0.9); backdrop-filter: blur(8px); }
        .animate-ui { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        .grade-cell { 
            transition: all 0.2s ease; 
            border-right: 1px solid #f1f5f9;
            text-align: center; font-weight: 700;
        }
        .risk-alert { background-color: #fef2f2 !important; color: #ef4444 !important; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800 bg-slate-100">

    <!-- SIDEBAR -->
    <aside id="sidebar-container" class="sidebar-transition w-72 bg-fmm-dark text-white flex-shrink-0 flex flex-col shadow-2xl relative z-50"></aside>

    <!-- ÁREA PRINCIPAL -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        
        <!-- HEADER (Otimizado para espaço) -->
        <header class="bg-white border-b border-slate-200 z-40 flex-shrink-0">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between p-3 lg:px-6 gap-3">
                
                <!-- Título e Seleção -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 flex-1">
                    <div class="flex flex-col min-w-max">
                        <h1 class="text-lg font-black text-fmm-dark tracking-tight flex items-center gap-2">
                            <span class="w-1.5 h-4 bg-fmm-green rounded-full"></span>
                            Mapa Geral
                        </h1>
                    </div>

                    <div class="h-6 w-px bg-slate-200 hidden sm:block"></div>

                    <!-- Controles Principais -->
                    <div class="flex flex-wrap items-center gap-2 w-full">
                        <div class="relative flex-1 sm:flex-none min-w-[140px]">
                            <select id="classSelector" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-xs font-bold px-3 py-2 rounded-lg focus:ring-2 focus:ring-fmm-blue outline-none cursor-pointer appearance-none" onchange="loadClassMap()">
                                <option value="" disabled selected>Selecionar Turma...</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                        </div>
                        
                        <div class="relative group flex-1 sm:flex-none min-w-[140px]">
                            <i data-lucide="search" class="absolute left-4 top-2.5 w-3 h-3 text-slate-400"></i>
                            <input type="text" id="searchInput" placeholder="Buscar aluno..." class="w-full pl-8 pr-3 py-2 bg-slate-50 border border-slate-200 text-xs font-medium rounded-lg focus:ring-2 focus:ring-fmm-blue outline-none transition-all" onkeyup="handleSearch(this.value)">
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação e Períodos -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <button id="btnRiskFilter" onclick="toggleRiskFilter()" class="flex justify-center items-center gap-2 px-3 py-2 rounded-lg border border-slate-200 text-slate-500 bg-white hover:border-red-200 hover:text-red-500 transition-all text-[10px] font-black uppercase tracking-wider shadow-sm active:scale-95 whitespace-nowrap">
                        <i data-lucide="shield-alert" class="w-3.5 h-3.5"></i> <span class="hidden xl:inline">Identificar</span> Risco
                    </button>
                    
                    <div class="h-6 w-px bg-slate-200 hidden sm:block"></div>

                    <!-- Navegação Compacta (Dinâmica) -->
                    <div id="periodNavigation" class="flex bg-slate-100 p-1 rounded-lg gap-0.5 border border-slate-200 overflow-x-auto no-scrollbar">
                        <button onclick="switchPeriod('anual')" id="btn-anual" class="view-btn px-3 py-1.5 rounded-md text-[10px] font-black uppercase transition-all bg-fmm-blue text-white shadow-sm">Anual</button>
                        <!-- Injetado via JS dependendo do nível -->
                    </div>
                </div>
            </div>
        </header>

        <!-- ÁREA DA MATRIZ (Expandida) -->
        <main class="flex-1 overflow-hidden p-2 md:p-4 relative flex flex-col">
            
            <div id="loadingOverlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden rounded-2xl">
                <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-fmm-blue mb-3"></div>
                <p class="text-fmm-dark font-black text-[10px] uppercase tracking-widest animate-pulse">Carregando...</p>
            </div>

            <!-- CONTAINER DA TABELA (Foco nos dados) -->
            <div class="flex-1 overflow-auto custom-scrollbar bg-white rounded-2xl shadow-lg border border-slate-200 relative">
                <table class="text-[11px] text-left border-separate border-spacing-0 w-max min-w-full">
                    <thead id="tableHeader" class="z-30"></thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
                
                <!-- EMPTY STATE -->
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 bg-white z-10 p-4 text-center">
                    <div class="bg-slate-50 p-6 rounded-full mb-4 border border-slate-100">
                        <i data-lucide="layout-grid" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <h3 class="text-sm font-black text-fmm-dark uppercase tracking-widest mb-1">Visão Geral</h3>
                    <p class="text-xs text-slate-400">Selecione uma turma para iniciar a análise.</p>
                </div>
            </div>
        </main>
    </main>

    <!-- MODAL DE DETALHES -->
    <div id="studentDetailModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col animate-ui overflow-hidden border border-white/20">
            <!-- Header Compacto -->
            <div class="bg-fmm-dark p-6 flex justify-between items-center text-white relative">
                <div class="flex items-center gap-5 relative z-10">
                    <img id="modalAvatar" src="" class="w-16 h-16 rounded-xl border-2 border-white/20 bg-slate-800 object-cover shadow-lg">
                    <div>
                        <h2 id="modalStudentName" class="text-xl md:text-2xl font-black leading-tight tracking-tight line-clamp-1">---</h2>
                        <div class="flex gap-3 text-[10px] font-bold uppercase tracking-widest text-fmm-lime mt-1 opacity-90">
                            <span id="modalStudentRA">RA: 0000</span>
                            <span class="text-white/20">|</span>
                            <span id="modalStudentClass">Turma</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeStudentModal()" class="bg-white/10 hover:bg-red-500 hover:text-white p-2.5 rounded-full transition-all relative z-10">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Corpo -->
            <div class="flex-1 overflow-auto p-6 bg-slate-50/50 custom-scrollbar space-y-6">
                <div class="space-y-6">
                    <!-- ÁREA BÁSICA (Dinamizada para Bimestres) -->
                    <div class="bg-white shadow-sm rounded-2xl overflow-hidden border border-slate-200">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-fmm-blue"></span>
                            <h3 id="modalBasicLabel" class="text-[10px] font-black text-fmm-dark uppercase tracking-widest">Ensino Básico</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left border-collapse whitespace-nowrap">
                                <thead id="modalBasicHead" class="bg-white text-[9px] font-black uppercase tracking-widest border-b border-slate-100 text-slate-500">
                                    <!-- Dinâmico -->
                                </thead>
                                <tbody id="modalGradesBody" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ÁREA TÉCNICA (Oculta se for Fundamental) -->
                    <div id="modalTechContainer" class="bg-white shadow-sm rounded-2xl overflow-hidden border border-slate-200">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-fmm-green"></span>
                            <h3 class="text-[10px] font-black text-fmm-dark uppercase tracking-widest">Ensino Técnico</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left border-collapse whitespace-nowrap">
                                <thead class="bg-white text-[9px] font-black uppercase tracking-widest border-b border-slate-100 text-slate-500">
                                    <tr>
                                        <th class="p-3 w-56 border-r text-fmm-dark">Disciplina</th>
                                        <th class="p-2 text-center border-r">Semestre</th>
                                        <th class="p-1 text-center w-10">P1</th>
                                        <th class="p-1 text-center w-10">P2</th>
                                        <th class="p-1 text-center w-10 bg-blue-50/50 font-bold">M1</th>
                                        <th class="p-1 text-center w-10">RP</th>
                                        <th class="p-1 text-center w-10">CONS</th>
                                        <th class="p-1 text-center w-10 bg-orange-50/50 font-bold text-orange-600">RF</th>
                                        <th class="p-2 text-center bg-fmm-dark text-white w-16 font-bold">NF</th>
                                    </tr>
                                </thead>
                                <tbody id="modalTechBody" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-white border-t border-slate-100 flex justify-end">
                <button onclick="closeStudentModal()" class="px-6 py-2.5 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-fmm-blue transition-all shadow-md">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let basicSubjects = [];
        let techSubjects = [];
        let currentClassData = [];
        let currentView = 'anual';
        let showRiskOnly = false;
        let searchTimeout = null;
        let isFundamental = false;

        const TECH_CURRICULUM = {
            '1ª Série': { 1: ['AMC', 'CEI', 'PC', 'TM'], 2: ['CE', 'M3DMA', 'PMF', 'POO', 'DP'] },
            '2ª Série': { 1: ['AI-I', 'DW-I', 'ILR', 'LBD', 'PM'], 2: ['DW-II', 'PDM-I', 'LPR', 'IPF', 'DSE-I'] },
            '3ª Série': { 1: ['AI-II', 'DJ', 'DSE-II', 'PDM-II', 'PFI', 'PFM', 'SHP'], 2: ['GPP', 'GPS', 'IOT E NT', 'ONST', 'PCPS', 'TS', 'VC'] }
        };

        const HIDDEN_SUBJECTS = ['ATUAL', 'BIO.APL', 'ENS.RELIG', 'FÍSICA.APL', 'GEO.APL', 'HIST.APL', 'L.ING', 'P.DESP', 'QUIM.APL'];

        function formatDriveUrl(url) {
            if (!url) return null;
            if (url.includes('drive.google.com') && url.includes('/file/d/')) {
                const idMatch = url.match(/\/d\/(.*?)\//);
                if (idMatch && idMatch[1]) return `https://lh3.googleusercontent.com/d/${idMatch[1]}`;
            }
            return url;
        }

        async function init() {
            if(window.SidebarComponent) await window.SidebarComponent.render('sidebar-container');
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) return window.location.href = '../../index.html';

            await loadMetadata();
            lucide.createIcons();
        }

        async function loadMetadata() {
            const { data: turmas } = await window.supabaseClient.from('turmas').select('*').order('nome');
            const select = document.getElementById('classSelector');
            if (turmas) {
                turmas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR', { numeric: true }));
                turmas.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.nome;
                    opt.dataset.serie = t.serie;
                    opt.dataset.nivel = t.nivel;
                    select.appendChild(opt);
                });
            }

            const { data: discs } = await window.supabaseClient.from('disciplinas').select('*').order('nome');
            const visibleDiscs = discs ? discs.filter(d => !HIDDEN_SUBJECTS.includes(d.sigla)) : [];
            basicSubjects = visibleDiscs.filter(d => d.tipo === 'BCC').map(d => ({ ...d, shortName: d.sigla }));
            techSubjects = visibleDiscs.filter(d => d.tipo === 'Técnica').map(d => ({ ...d, shortName: d.sigla }));
        }

        function updatePeriodNavigation() {
            const nav = document.getElementById('periodNavigation');
            const sel = document.getElementById('classSelector');
            const nivel = sel.options[sel.selectedIndex]?.dataset.nivel || '';
            isFundamental = (nivel === 'EF1' || nivel === 'EF2');

            let html = `<button onclick="switchPeriod('anual')" id="btn-anual" class="view-btn px-3 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${currentView === 'anual' ? 'bg-fmm-blue text-white shadow-sm' : 'text-slate-500 hover:text-fmm-blue'}">Anual</button>`;
            
            if (isFundamental) {
                const bim = ['1_BIMESTRE', '2_BIMESTRE', '3_BIMESTRE', '4_BIMESTRE'];
                bim.forEach((b, i) => {
                    const active = currentView === b ? 'bg-fmm-blue text-white shadow-sm' : 'text-slate-500 hover:text-fmm-blue';
                    html += `<button onclick="switchPeriod('${b}')" id="btn-${b}" class="view-btn px-2 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${active}">${i+1}B</button>`;
                });
            } else {
                const tri = ['1_TRIMESTRE', '2_TRIMESTRE', '3_TRIMESTRE'];
                tri.forEach((t, i) => {
                    const active = currentView === t ? 'bg-fmm-blue text-white shadow-sm' : 'text-slate-500 hover:text-fmm-blue';
                    html += `<button onclick="switchPeriod('${t}')" id="btn-${t}" class="view-btn px-2 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${active}">${i+1}T</button>`;
                });
                html += `<div class="w-px bg-slate-300 mx-1 h-3 self-center"></div>`;
                html += `<button onclick="switchPeriod('1_SEMESTRE_TEC')" id="btn-1_SEMESTRE_TEC" class="view-btn px-2 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${currentView === '1_SEMESTRE_TEC' ? 'bg-fmm-green text-white shadow-sm' : 'text-slate-500 hover:text-fmm-green'} flex items-center gap-1"><i data-lucide="cpu" class="w-3 h-3"></i>1S</button>`;
                html += `<button onclick="switchPeriod('2_SEMESTRE_TEC')" id="btn-2_SEMESTRE_TEC" class="view-btn px-2 py-1.5 rounded-md text-[10px] font-black uppercase transition-all ${currentView === '2_SEMESTRE_TEC' ? 'bg-fmm-green text-white shadow-sm' : 'text-slate-500 hover:text-fmm-green'} flex items-center gap-1"><i data-lucide="cpu" class="w-3 h-3"></i>2S</button>`;
            }
            nav.innerHTML = html;
            lucide.createIcons();
        }

        async function loadClassMap() {
            const classId = document.getElementById('classSelector').value;
            if (!classId) return;

            updatePeriodNavigation();

            const loader = document.getElementById('loadingOverlay');
            const empty = document.getElementById('emptyState');
            loader.classList.remove('hidden');
            empty.classList.add('hidden');

            try {
                const { data: matriculas } = await window.supabaseClient.from('matriculas')
                    .select('id, ra_aluno, alunos(ra, nome_completo, url_foto)')
                    .eq('id_turma', classId).eq('status', 'CURSANDO').eq('ano_letivo', 2026);

                if (!matriculas || matriculas.length === 0) throw new Error("Sem alunos registrados.");
                matriculas.sort((a, b) => (a.alunos?.nome_completo || "").localeCompare(b.alunos?.nome_completo || ""));
                
                const ids = matriculas.map(m => m.id);

                let fetchPromises = [];
                if (isFundamental) {
                    fetchPromises = [
                        window.supabaseClient.from('notas_fundamental').select('*').in('id_matricula', ids),
                        window.supabaseClient.from('anual_fundamental').select('*').in('id_matricula', ids),
                        Promise.resolve({ data: [] }) // Dummy TEC
                    ];
                } else {
                    fetchPromises = [
                        window.supabaseClient.from('notas_basica').select('*').in('id_matricula', ids),
                        window.supabaseClient.from('anual_basica').select('*').in('id_matricula', ids),
                        window.supabaseClient.from('notas_tecnica').select('*').in('id_matricula', ids)
                    ];
                }

                const [resNotas, resAnual, resTech] = await Promise.all(fetchPromises);

                currentClassData = matriculas.map(m => {
                    const student = { id: m.id, ra: m.alunos.ra, nome: m.alunos.nome_completo, foto: m.alunos.url_foto, gradesBCC: {}, gradesTEC: {} };
                    
                    basicSubjects.forEach(s => {
                        const an = (resAnual.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla) || {};
                        const n1 = (resNotas.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && (isFundamental ? x.periodo === '1_BIMESTRE' : x.periodo === '1_TRIMESTRE')) || {};
                        const n2 = (resNotas.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && (isFundamental ? x.periodo === '2_BIMESTRE' : x.periodo === '2_TRIMESTRE')) || {};
                        const n3 = (resNotas.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && (isFundamental ? x.periodo === '3_BIMESTRE' : x.periodo === '3_TRIMESTRE')) || {};
                        const n4 = isFundamental ? (resNotas.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && x.periodo === '4_BIMESTRE') || {} : null;

                        student.gradesBCC[s.sigla] = { 
                            p1: n1[isFundamental ? 'nb' : 'nt'], 
                            p2: n2[isFundamental ? 'nb' : 'nt'], 
                            p3: n3[isFundamental ? 'nb' : 'nt'], 
                            p4: n4 ? n4.nb : null,
                            anual: an.media_final, 
                            raw: { n1, n2, n3, n4, an } 
                        };
                    });

                    if (!isFundamental) {
                        techSubjects.forEach(s => {
                            const s1 = (resTech.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && x.periodo === '1_SEMESTRE') || {};
                            const s2 = (resTech.data || []).find(x => x.id_matricula === m.id && x.sigla_disciplina === s.sigla && x.periodo === '2_SEMESTRE') || {};
                            student.gradesTEC[s.sigla] = { s1: s1.nota_final_periodo, s2: s2.nota_final_periodo, raw: { s1, s2 } };
                        });
                    }
                    return student;
                });
                renderTable();
            } catch (err) { console.error(err); empty.classList.remove('hidden'); }
            finally { loader.classList.add('hidden'); lucide.createIcons(); }
        }

        function renderTable() {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            const sel = document.getElementById('classSelector');
            const currentSerie = sel.options[sel.selectedIndex]?.dataset.serie || '1ª Série';

            let columns = [];
            const isViewTech = currentView.includes('SEMESTRE_TEC');

            if (!isViewTech) {
                columns = basicSubjects.map(s => ({ id: s.sigla, label: s.shortName, tooltip: s.nome, isTech: false }));
            } else {
                const sem = currentView === '1_SEMESTRE_TEC' ? 1 : 2;
                const curriculo = TECH_CURRICULUM[currentSerie] || { 1: [], 2: [] };
                columns = techSubjects.filter(s => (curriculo[sem] || []).includes(s.sigla)).map(s => ({ id: s.sigla, label: s.shortName, tooltip: s.nome, isTech: true }));
                columns.sort((a,b) => a.label.localeCompare(b.label));
            }

            let headHTML = `<tr><th class="sticky-col-ra text-center">RA</th><th class="sticky-col-aluno text-left px-4">Estudante</th>`;
            columns.forEach(c => {
                const bg = c.isTech ? 'bg-fmm-green/90' : 'bg-[#1e293b]';
                headHTML += `<th class="px-2 text-center border-l border-white/5 ${bg}" title="${c.tooltip}">${c.label}</th>`;
            });
            thead.innerHTML = headHTML + `</tr>`;

            let bodyHTML = '';
            currentClassData.forEach((student) => {
                if (showRiskOnly) {
                    const hasRisk = columns.some(col => {
                        let val = 0;
                        if (col.isTech) val = student.gradesTEC[col.id]?.[currentView === '1_SEMESTRE_TEC' ? 's1' : 's2'];
                        else {
                            const mapping = { 'anual': 'anual', '1_TRIMESTRE': 'p1', '2_TRIMESTRE': 'p2', '3_TRIMESTRE': 'p3', '1_BIMESTRE': 'p1', '2_BIMESTRE': 'p2', '3_BIMESTRE': 'p3', '4_BIMESTRE': 'p4' };
                            val = student.gradesBCC[col.id]?.[mapping[currentView]];
                        }
                        return val > 0 && val < 6.0;
                    });
                    if (!hasRisk) return;
                }

                const avatar = formatDriveUrl(student.foto) || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome)}&background=random`;
                bodyHTML += `<tr class="hover:bg-fmm-blue/5 transition-colors group">
                    <td class="sticky-col-ra px-1 py-3 text-center font-mono font-bold text-slate-400 text-[10px]">${student.ra}</td>
                    <td class="sticky-col-aluno px-3 py-2 font-bold text-fmm-dark">
                        <div class="flex items-center gap-2">
                            <img src="${avatar}" class="w-8 h-8 rounded-lg object-cover bg-white shadow-sm border border-slate-100 flex-shrink-0">
                            <button onclick="openStudentDetails('${student.id}')" class="hover:text-fmm-blue hover:underline text-left truncate flex-1 tracking-tight text-[11px] md:text-xs uppercase">
                                ${student.nome}
                            </button>
                        </div>
                    </td>`;

                columns.forEach(col => {
                    let val = 0;
                    if (col.isTech) val = student.gradesTEC[col.id]?.[currentView === '1_SEMESTRE_TEC' ? 's1' : 's2'];
                    else {
                        const mapping = { 'anual': 'anual', '1_TRIMESTRE': 'p1', '2_TRIMESTRE': 'p2', '3_TRIMESTRE': 'p3', '1_BIMESTRE': 'p1', '2_BIMESTRE': 'p2', '3_BIMESTRE': 'p3', '4_BIMESTRE': 'p4' };
                        val = student.gradesBCC[col.id]?.[mapping[currentView]];
                    }
                    const color = (val > 0 && val < 6.0) ? 'risk-alert' : (val >= 6.0 ? 'text-fmm-blue font-black' : 'text-slate-300 font-medium');
                    bodyHTML += `<td class="grade-cell text-center font-mono text-[11px] ${color}">${(val > 0) ? Number(val).toFixed(1) : '-'}</td>`;
                });
                bodyHTML += `</tr>`;
            });
            tbody.innerHTML = bodyHTML || `<tr><td colspan="${columns.length + 2}" class="p-10 text-center text-slate-300 italic">Nenhum registro encontrado.</td></tr>`;
        }

        function toggleRiskFilter() {
            showRiskOnly = !showRiskOnly;
            const btn = document.getElementById('btnRiskFilter');
            btn.classList.toggle('border-red-500', showRiskOnly);
            btn.classList.toggle('text-red-500', showRiskOnly);
            btn.classList.toggle('bg-red-50', showRiskOnly);
            renderTable();
        }

        function switchPeriod(p) {
            currentView = p;
            document.querySelectorAll('.view-btn').forEach(b => {
                b.className = "view-btn px-2 sm:px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase text-slate-400 hover:bg-white hover:text-fmm-blue transition-all";
                if(b.id === `btn-${p}`) {
                    const colorClass = p.includes('TEC') ? 'bg-fmm-green' : 'bg-fmm-blue';
                    b.className = `view-btn px-2 sm:px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all shadow-sm ${colorClass} text-white`;
                }
            });
            renderTable();
        }

        function handleSearch(val) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const rows = document.querySelectorAll('#tableBody tr');
                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(val.toLowerCase()) ? '' : 'none';
                });
            }, 300);
        }

        function openStudentDetails(matId) {
            const student = currentClassData.find(s => s.id === matId);
            if (!student) return;
            document.getElementById('modalStudentName').innerText = student.nome;
            document.getElementById('modalStudentRA').innerText = `RA: ${student.ra}`;
            document.getElementById('modalStudentClass').innerText = document.getElementById('classSelector').options[document.getElementById('classSelector').selectedIndex].text;
            document.getElementById('modalAvatar').src = formatDriveUrl(student.foto) || `https://ui-avatars.com/api/?name=${encodeURIComponent(student.nome)}&background=random`;

            // Configura modal labels
            document.getElementById('modalBasicLabel').innerText = isFundamental ? 'Ensino Fundamental (Bimestres)' : 'Ensino Médio (Trimestres)';
            const headB = document.getElementById('modalBasicHead');
            
            if (isFundamental) {
                headB.innerHTML = `
                    <tr>
                        <th class="p-3 border-r w-48 sticky left-0 bg-white z-10">Disciplina</th>
                        <th class="p-2 text-center bg-blue-50/30 border-r" colspan="4">1º Bim</th>
                        <th class="p-2 text-center bg-indigo-50/30 border-r" colspan="4">2º Bim</th>
                        <th class="p-2 text-center bg-purple-50/30 border-r" colspan="4">3º Bim</th>
                        <th class="p-2 text-center bg-green-50/30 border-r" colspan="4">4º Bim</th>
                        <th class="p-2 text-center bg-fmm-dark text-white" colspan="3">Final</th>
                    </tr>
                    <tr class="text-[8px]">
                        <th class="border-r bg-white sticky left-0 z-10"></th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RB</th><th class="p-1 text-center font-bold border-r">NB</th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RB</th><th class="p-1 text-center font-bold border-r">NB</th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RB</th><th class="p-1 text-center font-bold border-r">NB</th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RB</th><th class="p-1 text-center font-bold border-r">NB</th>
                        <th class="p-1 text-center bg-slate-100 font-bold">ANUAL</th><th class="p-1 text-center bg-slate-100 text-orange-600 font-bold">REC</th><th class="p-1 text-center bg-fmm-dark text-white font-bold">MF</th>
                    </tr>`;
            } else {
                headB.innerHTML = `
                    <tr>
                        <th class="p-3 border-r w-48 sticky left-0 bg-white z-10">Disciplina</th>
                        <th class="p-2 text-center bg-blue-50/30 border-r" colspan="4">1º Tri</th>
                        <th class="p-2 text-center bg-indigo-50/30 border-r" colspan="4">2º Tri</th>
                        <th class="p-2 text-center bg-purple-50/30 border-r" colspan="4">3º Tri</th>
                        <th class="p-2 text-center bg-fmm-dark text-white" colspan="3">Final</th>
                    </tr>
                    <tr class="text-[8px]">
                        <th class="border-r bg-white sticky left-0 z-10"></th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RT</th><th class="p-1 text-center font-bold border-r">NT</th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RT</th><th class="p-1 text-center font-bold border-r">NT</th>
                        <th class="p-1 text-center">P1</th><th class="p-1 text-center">P2</th><th class="p-1 text-center">RT</th><th class="p-1 text-center font-bold border-r">NT</th>
                        <th class="p-1 text-center bg-slate-100 font-bold">ANUAL</th><th class="p-1 text-center bg-slate-100 text-orange-600 font-bold">REC</th><th class="p-1 text-center bg-fmm-dark text-white font-bold">MF</th>
                    </tr>`;
            }

            const tbodyB = document.getElementById('modalGradesBody');
            tbodyB.innerHTML = Object.entries(student.gradesBCC).map(([sigla, g]) => {
                const sub = basicSubjects.find(s => s.sigla === sigla);
                const fmt = (v) => (v !== null && v !== undefined && v !== 0) ? Number(v).toFixed(1) : '-';
                const cls = (v) => (v > 0 && v < 6.0) ? 'text-red-500 font-black' : (v >= 6.0 ? 'text-fmm-blue font-bold' : 'text-slate-300');
                
                let row = `<tr><td class="p-3 font-bold text-fmm-dark text-[11px] border-r sticky left-0 bg-white uppercase">${sub?.nome || sigla}</td>`;
                
                const steps = isFundamental ? ['n1','n2','n3','n4'] : ['n1','n2','n3'];
                steps.forEach(sKey => {
                    const n = g.raw[sKey] || {};
                    row += `<td class="p-1 text-center text-slate-500 font-mono">${fmt(n.p1)}</td>
                            <td class="p-1 text-center text-slate-500 font-mono">${fmt(n.p2)}</td>
                            <td class="p-1 text-center text-orange-400 italic font-mono">${fmt(n[isFundamental ? 'rb' : 'rt'])}</td>
                            <td class="p-1 text-center border-r bg-blue-50/10 ${cls(n[isFundamental ? 'nb' : 'nt'])}">${fmt(n[isFundamental ? 'nb' : 'nt'])}</td>`;
                });

                row += `<td class="p-1 text-center bg-slate-100/50 font-bold">${fmt(g.raw.an?.media_anual)}</td>
                        <td class="p-1 text-center bg-slate-100/50 text-orange-600 font-bold">${fmt(g.raw.an?.recup_final)}</td>
                        <td class="p-1 text-center bg-fmm-dark text-white font-black text-xs">${fmt(g.anual)}</td></tr>`;
                return row;
            }).join('');

            const techCont = document.getElementById('modalTechContainer');
            const tbodyT = document.getElementById('modalTechBody');
            if (isFundamental) {
                techCont.classList.add('hidden');
            } else {
                techCont.classList.remove('hidden');
                const tecs = Object.entries(student.gradesTEC).filter(([_, g]) => (g.s1 || 0) > 0 || (g.s2 || 0) > 0);
                tbodyT.innerHTML = tecs.map(([sigla, g]) => {
                    const sub = techSubjects.find(s => s.sigla === sigla);
                    const fmt = (v) => (v > 0) ? Number(v).toFixed(1) : '-';
                    let r = '';
                    if((g.s1 || 0) > 0 || (g.raw.s1?.p1 || 0) > 0) r += `<tr class="hover:bg-slate-50 transition border-b"><td class="p-3 font-bold text-[11px] border-r text-fmm-dark uppercase">${sub?.nome}</td><td class="p-1 text-center border-r font-bold text-slate-400 text-[9px] uppercase">1º Sem</td><td class="p-1 text-center font-mono">${fmt(g.raw.s1.p1)}</td><td class="p-1 text-center font-mono">${fmt(g.raw.s1.p2)}</td><td class="p-1 text-center bg-blue-50/30 text-fmm-blue font-bold">${fmt(g.raw.s1.media_1)}</td><td class="p-1 text-center text-orange-500 font-mono">${fmt(g.raw.s1.recup_parcial)}</td><td class="p-1 text-center text-fmm-blue font-mono">${fmt(g.raw.s1.conselho_semestral)}</td><td class="p-1 text-center bg-orange-50/30 text-orange-600 font-mono">${fmt(g.raw.s1.recup_final_semestral)}</td><td class="p-2 text-center bg-slate-800 text-white font-black text-xs">${fmt(g.s1)}</td></tr>`;
                    if((g.s2 || 0) > 0 || (g.raw.s2?.p1 || 0) > 0) r += `<tr class="hover:bg-slate-50 transition border-b"><td class="p-3 font-bold text-[11px] border-r text-fmm-dark uppercase">${sub?.nome}</td><td class="p-1 text-center border-r font-bold text-slate-400 text-[9px] uppercase">2º Sem</td><td class="p-1 text-center font-mono">${fmt(g.raw.s2.p1)}</td><td class="p-1 text-center font-mono">${fmt(g.raw.s2.p2)}</td><td class="p-1 text-center bg-blue-50/30 text-fmm-blue font-bold">${fmt(g.raw.s2.media_1)}</td><td class="p-1 text-center text-orange-500 font-mono">${fmt(g.raw.s2.recup_parcial)}</td><td class="p-1 text-center text-fmm-blue font-mono">${fmt(g.raw.s2.conselho_semestral)}</td><td class="p-1 text-center bg-orange-50/30 text-orange-600 font-mono">${fmt(g.raw.s2.recup_final_semestral)}</td><td class="p-2 text-center bg-slate-800 text-white font-black text-xs">${fmt(g.s2)}</td></tr>`;
                    return r;
                }).join('') || '<tr><td colspan="9" class="p-8 text-center text-slate-300 italic text-xs uppercase">Sem notas técnicas vinculadas.</td></tr>';
            }

            document.getElementById('studentDetailModal').classList.remove('hidden'); lucide.createIcons();
        }

        function closeStudentModal() { document.getElementById('studentDetailModal').classList.add('hidden'); }
        function toggleSidebar() { if(window.SidebarComponent) SidebarComponent.toggleSidebar(); }
        async function logout() { if(confirm("Deseja sair do sistema?")) { await window.supabaseClient.auth.signOut(); window.location.href = "../../index.html"; } }
        window.onload = init;
    </script>
</body>
</html>